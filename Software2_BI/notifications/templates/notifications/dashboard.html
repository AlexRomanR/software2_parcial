{% extends "base.html" %} {% load static %} {% block title %}Sistema de
Alertas{% endblock %} {% block content %}
<div class="container-fluid py-2">
  <!-- Resumen de alertas -->
  <div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Total Alertas</p>
              <h4 class="mb-0">{{ alert_summary.total }}</h4>
            </div>
            <div
              class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg"
            >
              <i class="material-symbols-rounded opacity-10"
                >notification_important</i
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Nuevas</p>
              <h4 class="mb-0">{{ alert_summary.new }}</h4>
            </div>
            <div
              class="icon icon-md icon-shape bg-gradient-warning shadow-warning text-center border-radius-lg"
            >
              <i class="material-symbols-rounded opacity-10">new_releases</i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Críticas</p>
              <h4 class="mb-0">{{ alert_summary.critical }}</h4>
            </div>
            <div
              class="icon icon-md icon-shape bg-gradient-danger shadow-danger text-center border-radius-lg"
            >
              <i class="material-symbols-rounded opacity-10">error</i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">KPIs Activos</p>
              <h4 class="mb-0">{{ user_kpis.count }}</h4>
            </div>
            <div
              class="icon icon-md icon-shape bg-gradient-success shadow-success text-center border-radius-lg"
            >
              <i class="material-symbols-rounded opacity-10">trending_up</i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones rápidas -->
  <div class="row mt-4">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Acciones Rápidas</h6>
          <button id="run-alerts-btn" class="btn btn-primary btn-sm">
            <i class="material-symbols-rounded me-1" style="font-size: 16px;">play_arrow</i>
            <span id="btn-text">Ejecutar Alertas</span>
          </button>
        </div>
        <div class="card-body">
          <!-- Mensaje de resultado de ejecución -->
          <div id="alert-execution-result" class="alert alert-dismissible fade mb-3" role="alert" style="display: none;">
            <span id="result-message"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          
          <div class="row">
            <div class="col-md-6 col-xl-3">
              <a
                href="{% url 'notifications:create_kpi' %}"
                class="btn btn-success w-100 mb-2"
              >
                <i class="material-symbols-rounded me-2">add</i>Crear KPI
              </a>
            </div>
            <div class="col-md-6 col-xl-3">
              <a
                href="{% url 'notifications:create_alert_rule' %}"
                class="btn btn-warning w-100 mb-2"
              >
                <i class="material-symbols-rounded me-2">notification_add</i
                >Nueva Regla de Alerta
              </a>
            </div>
            <div class="col-md-6 col-xl-3">
              <a
                href="{% url 'notifications:list_kpis' %}"
                class="btn btn-info w-100 mb-2"
              >
                <i class="material-symbols-rounded me-2">analytics</i>Ver KPIs
              </a>
            </div>
            <div class="col-md-6 col-xl-3">
              <a
                href="{% url 'notifications:list_alert_rules' %}"
                class="btn btn-secondary w-100 mb-2"
              >
                <i class="material-symbols-rounded me-2">rule</i>Ver Reglas
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas recientes -->
  <div class="row mt-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Alertas Recientes</h6>
        </div>
        <div class="card-body px-0 pb-2">
          {% if alerts %}
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    KPI
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Valor
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Severidad
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Estado
                  </th>
                  <th
                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for alert in alerts %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">
                          {{ alert.alert_rule.kpi.name }}
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          {{ alert.triggered_at|date:"d/m/Y H:i" }}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">
                      {{ alert.current_value }}
                    </p>
                    <p class="text-xs text-secondary mb-0">
                      Umbral: {{ alert.threshold_value }}
                    </p>
                  </td>
                  <td>
                    {% if alert.alert_rule.severity == 'critical' %}
                    <span class="badge badge-sm bg-gradient-danger"
                      >{{ alert.alert_rule.get_severity_display }}</span
                    >
                    {% elif alert.alert_rule.severity == 'high' %}
                    <span class="badge badge-sm bg-gradient-warning"
                      >{{ alert.alert_rule.get_severity_display }}</span
                    >
                    {% elif alert.alert_rule.severity == 'medium' %}
                    <span class="badge badge-sm bg-gradient-info"
                      >{{ alert.alert_rule.get_severity_display }}</span
                    >
                    {% else %}
                    <span class="badge badge-sm bg-gradient-secondary"
                      >{{ alert.alert_rule.get_severity_display }}</span
                    >
                    {% endif %}
                  </td>
                  <td>
                    {% if alert.status == 'new' %}
                    <span class="badge badge-sm bg-gradient-warning"
                      >{{ alert.get_status_display }}</span
                    >
                    {% elif alert.status == 'acknowledged' %}
                    <span class="badge badge-sm bg-gradient-info"
                      >{{ alert.get_status_display }}</span
                    >
                    {% elif alert.status == 'resolved' %}
                    <span class="badge badge-sm bg-gradient-success"
                      >{{ alert.get_status_display }}</span
                    >
                    {% else %}
                    <span class="badge badge-sm bg-gradient-secondary"
                      >{{ alert.get_status_display }}</span
                    >
                    {% endif %}
                  </td>
                  <td class="align-middle text-center">
                    {% if alert.status == 'new' %}
                    <form
                      method="post"
                      action="{% url 'notifications:acknowledge_alert' alert.id %}"
                      class="d-inline"
                    >
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="btn btn-link text-info p-0 mb-0"
                      >
                        <i class="material-symbols-rounded text-sm"
                          >check_circle</i
                        >
                      </button>
                    </form>
                    {% endif %} {% if alert.status in 'new,acknowledged' %}
                    <form
                      method="post"
                      action="{% url 'notifications:resolve_alert' alert.id %}"
                      class="d-inline"
                    >
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="btn btn-link text-success p-0 mb-0"
                      >
                        <i class="material-symbols-rounded text-sm">task_alt</i>
                      </button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4">
            <i
              class="material-symbols-rounded text-muted"
              style="font-size: 48px"
              >notifications_none</i
            >
            <p class="text-muted">No hay alertas recientes</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- KPIs disponibles -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>KPIs Configurados</h6>
        </div>
        <div class="card-body">
          {% if user_kpis %} {% for kpi in user_kpis %}
          <div
            class="d-flex justify-content-between align-items-center py-2 border-bottom"
          >
            <div>
              <h6 class="mb-0 text-sm">{{ kpi.name }}</h6>
              <p class="text-xs text-secondary mb-0">
                {{ kpi.get_metric_type_display }} - {{ kpi.column_name }}
              </p>
            </div>
            <div>
              <a
                href="{% url 'notifications:test_kpi' kpi.id %}"
                class="btn btn-link text-info p-0 mb-0"
                title="Probar KPI"
              >
                <i class="material-symbols-rounded text-sm">play_arrow</i>
              </a>
              <a
                href="{% url 'notifications:create_alert_rule_for_kpi' kpi.id %}"
                class="btn btn-link text-warning p-0 mb-0"
                title="Crear alerta"
              >
                <i class="material-symbols-rounded text-sm">add_alert</i>
              </a>
            </div>
          </div>
          {% endfor %} {% else %}
          <div class="text-center py-4">
            <i
              class="material-symbols-rounded text-muted"
              style="font-size: 36px"
              >analytics</i
            >
            <p class="text-muted text-sm">No hay KPIs configurados</p>
            <a
              href="{% url 'notifications:create_kpi' %}"
              class="btn btn-sm btn-success"
              >Crear primer KPI</a
            >
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script para manejar el botón de ejecución -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('run-alerts-btn');
  const btnText = document.getElementById('btn-text');
  const btnIcon = btn.querySelector('.material-symbols-rounded');
  const resultDiv = document.getElementById('alert-execution-result');
  const resultMessage = document.getElementById('result-message');

  btn.addEventListener('click', function () {
    // Deshabilitar botón y mostrar estado de carga
    btn.disabled = true;
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
    btnIcon.textContent = 'hourglass_top';
    btnText.textContent = 'Ejecutando...';
    
    // Ocultar mensaje previo
    resultDiv.style.display = 'none';
    resultDiv.classList.remove('alert-success', 'alert-danger', 'alert-info');

    fetch("{% url 'notifications:run_alerts' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        // Mostrar mensaje de éxito
        resultDiv.classList.add('alert-success', 'show');
        
        if (data.triggered_count === 0) {
          resultMessage.innerHTML = '<i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">check_circle</i><strong>Ejecución completada:</strong> No se activaron nuevas alertas.';
        } else if (data.triggered_count === 1) {
          resultMessage.innerHTML = '<i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">notification_important</i><strong>¡Alerta activada!</strong> Se activó 1 nueva alerta.';
        } else {
          resultMessage.innerHTML = `<i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">notification_important</i><strong>¡Alertas activadas!</strong> Se activaron ${data.triggered_count} nuevas alertas.`;
        }
        
        resultDiv.style.display = 'block';
        
        // Recargar después de 2 segundos si hay nuevas alertas
        if (data.triggered_count > 0) {
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      } else {
        // Mostrar mensaje de error
        resultDiv.classList.add('alert-danger', 'show');
        resultMessage.innerHTML = `<i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">error</i><strong>Error:</strong> ${data.message || 'Ocurrió un error al ejecutar las alertas.'}`;
        resultDiv.style.display = 'block';
      }
    })
    .catch(err => {
      console.error('Error al ejecutar alertas:', err);
      // Mostrar mensaje de error
      resultDiv.classList.add('alert-danger', 'show');
      resultMessage.innerHTML = '<i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">error</i><strong>Error:</strong> No se pudo conectar con el servidor.';
      resultDiv.style.display = 'block';
    })
    .finally(() => {
      // Restaurar estado del botón
      btn.disabled = false;
      btn.classList.remove('btn-secondary');
      btn.classList.add('btn-primary');
      btnIcon.textContent = 'play_arrow';
      btnText.textContent = 'Ejecutar Alertas';
    });
  });
});
</script>
{% endblock %}