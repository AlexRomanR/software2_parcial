{% extends "base.html" %}
{% load static %}

{% block title %}ML · Predicción{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 col-lg-10">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ML · Predicción — {{ schema }}.{{ table }}</h5>
        <div>
          <a class="btn btn-outline-secondary" href="{% url 'prep:editor' schema=schema table=table %}">Volver al editor</a>
        </div>
      </div>
      <div class="card-body">
        <div id="ml-alert" class="alert d-none"></div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Objetivo (y)</label>
            <select id="ml-target" class="form-select"></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tarea</label>
            <select id="ml-task" class="form-select">
              <option value="auto" selected>Auto</option>
              <option value="classification">Clasificación</option>
              <option value="regression">Regresión</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Columna de tiempo</label>
            <select id="ml-time" class="form-select">
              <option value="">(ninguna)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">% Test</label>
            <input id="ml-test" class="form-control" type="number" value="20" min="5" max="50">
          </div>

          <div class="col-md-4">
            <label class="form-label">Algoritmo</label>
            <select id="ml-algo" class="form-select">
              <option value="auto" selected>Auto</option>
              <option value="rf">RandomForest</option>
              <option value="hgb">HistGB</option>
              <option value="logreg">Logistic</option>
              <option value="ridge">Ridge</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Columna predicción (opcional)</label>
            <input id="ml-writecol" class="form-control" placeholder="pred_target">
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Features (deja vacío para “todas menos y”)</label>
          <div id="ml-features" class="border rounded p-2" style="max-height:220px; overflow:auto;"></div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button id="ml-train" class="btn btn-primary">Entrenar</button>
          <button id="ml-predict" class="btn btn-success d-none">Predecir</button>
        </div>

        <hr>
        <h6>Métricas</h6>
        <pre id="ml-metrics" class="bg-light p-2 rounded d-none" style="max-height:260px; overflow:auto;"></pre>

        <h6 class="mt-3">Gráficos</h6>
        <div id="ml-charts"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const schema = "{{ schema }}", table = "{{ table }}";
  const alertBox = document.getElementById('ml-alert');
  const targetSel = document.getElementById('ml-target');
  const timeSel = document.getElementById('ml-time');
  const featBox = document.getElementById('ml-features');
  const metricsPre = document.getElementById('ml-metrics');
  const trainBtn = document.getElementById('ml-train');
  const predictBtn = document.getElementById('ml-predict');
  const chartsDiv = document.getElementById('ml-charts');

  function csrf(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }
  function setAlert(kind, text){
    alertBox.className = 'alert alert-'+kind;
    alertBox.textContent = text;
  }
  function clearCharts(){
    chartsDiv.innerHTML = '';
  }
  function renderCharts(charts){
    clearCharts();
    (charts || []).forEach((c, i) => {
      const card = document.createElement('div'); card.className='card mb-3';
      const h = document.createElement('div'); h.className='card-header'; h.textContent = c.title || `Gráfico ${i+1}`;
      const b = document.createElement('div'); b.className='card-body'; b.style.height = '340px';
      const canvas = document.createElement('canvas'); b.appendChild(canvas);
      card.appendChild(h); card.appendChild(b); chartsDiv.appendChild(card);
      new Chart(canvas.getContext('2d'), { type: c.chart_type || 'bar', data: c.data || {}, options: {responsive:true, maintainAspectRatio:false} });
    });
  }

  // Cargar columnas
  (async function(){
    const res = await fetch(`/ml/${encodeURIComponent(schema)}/${encodeURIComponent(table)}/config`);
    const j = await res.json();
    targetSel.innerHTML = j.columns.map(c => `<option>${c.name}</option>`).join('');
    timeSel.innerHTML = `<option value="">(ninguna)</option>` + j.columns
      .filter(c => /time|date|timestamp/i.test(c.type)).map(c => `<option>${c.name}</option>`).join('');
    featBox.innerHTML = j.columns.map(c => `
      <label class="d-block"><input type="checkbox" name="feat" value="${c.name}" checked> <span class="ms-1">${c.name} <small class="text-muted">(${c.type})</small></span></label>
    `).join('');
  })();

  trainBtn.addEventListener('click', async ()=>{
    setAlert('info','Entrenando modelo...');
    metricsPre.classList.add('d-none'); clearCharts(); predictBtn.classList.add('d-none');

    const feats = [...document.querySelectorAll('input[name="feat"]:checked')].map(x=>x.value);
    const payload = {
      target: targetSel.value,
      task: document.getElementById('ml-task').value,
      time_col: timeSel.value || null,
      test_size: parseInt(document.getElementById('ml-test').value||'20',10),
      algo: document.getElementById('ml-algo').value,
      features: feats
    };
    const res = await fetch(`/ml/${encodeURIComponent(schema)}/${encodeURIComponent(table)}/train`, {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrf()}, body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok){ setAlert('danger', j.error||'Error'); return; }
    setAlert('success','Modelo entrenado'); metricsPre.classList.remove('d-none');
    metricsPre.textContent = JSON.stringify(j.metrics,null,2);
    predictBtn.dataset.mid = j.model_id; predictBtn.classList.remove('d-none');
  });

  predictBtn.addEventListener('click', async ()=>{
    setAlert('info','Generando predicciones...');
    const payload = { model_id: predictBtn.dataset.mid, write_back_col: (document.getElementById('ml-writecol').value || null) };
    const res = await fetch(`/ml/${encodeURIComponent(schema)}/${encodeURIComponent(table)}/predict`, {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrf()}, body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok){ setAlert('danger', j.error||'Error'); return; }
    setAlert('success', `Predicciones listas (${j.n} filas)${j.write_back_col ? ' → columna '+j.write_back_col : ''}.`);
    renderCharts(j.charts);
    if (window.reloadGrid) window.reloadGrid(); // si estás en el editor, refresca la grilla
  });

})();
</script>
{% endblock %}
