{% extends "base.html" %}
{% block title %}Dashboard - {{ source.name }}{% endblock %}
{% block content %}
<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - {{ source.name }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .dashboard-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .diagramas-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
    }
    
    .chat-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .diagrama-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 15px 0;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .diagrama-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .diagrama-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    
    .diagrama-tipo {
      background: #e3f2fd;
      color: #1976d2;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .diagrama-auto {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .diagrama-chat {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .chart-container {
      width: 100%;
      height: 300px;
      position: relative;
    }
    
    .chart-canvas {
      max-height: 280px;
    }
    
    .diagrama-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .btn-small {
      padding: 5px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-update {
      background: #4caf50;
      color: white;
    }
    
    .btn-delete {
      background: #f44336;
      color: white;
    }
    
    .btn-export {
      background: #2196f3;
      color: white;
    }
    
    /* Chat styles */
    #chat-box {
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    
    .msg-user { color: #2563eb; margin: 5px 0; }
    .msg-bot { color: #059669; margin: 5px 0; }
    .msg-err { color: #dc2626; margin: 5px 0; }
    
    .chat-input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    #send-btn {
      padding: 10px 20px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .preview-section {
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
      border: 1px solid #b3d9ff;
      display: none;
    }
    
    .save-diagram-btn {
      background: #ff9800;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .file-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }
      
      .chat-section {
        position: static;
        order: -1;
      }
    }
  </style>
</head>
<body>
  <div class="file-info">
    <h2>üìä Dashboard - {{ source.name }}</h2>
    <p><strong>Archivo:</strong> {{ source.name }} | <strong>Tipo:</strong> {{ source.kind }}</p>
    <p><strong>Datos:</strong> {{ source.upload.rows_ingested|default:0 }} filas, {{ source.upload.columns|length|default:0 }} columnas</p>
    <p><strong>Diagramas:</strong> {{ diagramas|length }} total ({{ diagramas_automaticos|length }} autom√°ticos, {{ diagramas_chat|length }} del chat)</p>
  </div>

  <div class="dashboard-container">
    <!-- SECCI√ìN DE DIAGRAMAS -->
    <div class="diagramas-section">
      <h3>üìà Diagramas Generados</h3>
      
      {% if diagramas_automaticos %}
      <h4>ü§ñ Diagramas Autom√°ticos</h4>
      {% for diagrama in diagramas_automaticos %}
      <div class="diagrama-card">
        <div class="diagrama-header">
          <h5 class="diagrama-title">{{ diagrama.title }}</h5>
          <span class="diagrama-tipo diagrama-auto">AUTOM√ÅTICO</span>
        </div>
        
        {% if diagrama.description %}
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">{{ diagrama.description }}</p>
        {% endif %}
        
        <div class="chart-container">
          <canvas class="chart-canvas" id="chart-{{ diagrama.id }}"></canvas>
        </div>
        
        <div class="diagrama-actions">
          <button class="btn-small btn-update" onclick="actualizarDiagrama({{ diagrama.id }})">üîÑ Actualizar</button>
          <button class="btn-small btn-export" onclick="exportarDiagrama({{ diagrama.id }})">üì§ Exportar como imagen</button>
          <button class="btn-small btn-export" onclick="exportarPDF({{ diagrama.id }})">üìÑ Exportar como PDF</button>
          <button class="btn-small btn-export" onclick="abrirModalEmail({{ diagrama.id }}, '{{ diagrama.title|escapejs }}')">üìß Enviar como email</button>
          {% if diagrama.source_type == 'CHAT' %}
          <a href="{% url 'ingestion:eliminar_diagrama' diagrama.id %}" class="btn-small btn-delete" onclick="return confirm('¬øEliminar este diagrama?')">üóëÔ∏è Eliminar</a>
          {% endif %}
        </div>
      </div>
      
      <script>
      // Renderizar diagrama autom√°tico {{ diagrama.id }}
      (function() {
        const ctx = document.getElementById('chart-{{ diagrama.id }}').getContext('2d');
        const chartData = {{ diagrama.chart_data|safe }};
        
        new Chart(ctx, {
          type: '{{ diagrama.chart_type }}',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '{{ diagrama.title }}',
                font: { size: 14 }
              },
              legend: {
                display: chartData.datasets.length > 1 || '{{ diagrama.chart_type }}' === 'pie' || '{{ diagrama.chart_type }}' === 'doughnut'
              }
            }
          }
        });
      })();
      </script>
      {% endfor %}
      {% endif %}
      
      {% if diagramas_chat %}
      <h4>üí¨ Diagramas del Chat</h4>
      {% for diagrama in diagramas_chat %}
      <div class="diagrama-card">
        <div class="diagrama-header">
          <h5 class="diagrama-title">{{ diagrama.title }}</h5>
          <span class="diagrama-tipo diagrama-chat">CHAT</span>
        </div>
        
        {% if diagrama.description %}
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">{{ diagrama.description }}</p>
        {% endif %}
        
        <div class="chart-container">
          <canvas class="chart-canvas" id="chart-{{ diagrama.id }}"></canvas>
        </div>
        
        <div class="diagrama-actions">
          <button class="btn-small btn-update" onclick="actualizarDiagrama({{ diagrama.id }})">üîÑ Actualizar</button>
          <button class="btn-small btn-export" onclick="exportarDiagrama({{ diagrama.id }})">üì§ Exportar como imagen</button>
          <button class="btn-small btn-export" onclick="exportarPDF({{ diagrama.id }})">üìÑ Exportar como PDF</button>
          <button class="btn-small btn-export" onclick="abrirModalEmail({{ diagrama.id }}, '{{ diagrama.title|escapejs }}')">üìß Enviar como email</button>

          <a href="{% url 'ingestion:eliminar_diagrama' diagrama.id %}" class="btn-small btn-delete" onclick="return confirm('¬øEliminar este diagrama?')">üóëÔ∏è Eliminar</a>
        </div>
      </div>
      
      <script>
      // Renderizar diagrama del chat {{ diagrama.id }}
      (function() {
        const ctx = document.getElementById('chart-{{ diagrama.id }}').getContext('2d');
        const chartData = {{ diagrama.chart_data|safe }};
        
        new Chart(ctx, {
          type: '{{ diagrama.chart_type }}',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '{{ diagrama.title }}',
                font: { size: 14 }
              },
              legend: {
                display: chartData.datasets.length > 1 || '{{ diagrama.chart_type }}' === 'pie' || '{{ diagrama.chart_type }}' === 'doughnut'
              }
            }
          }
        });
      })();
      </script>
      {% endfor %}
      {% endif %}
      
      {% if not diagramas %}
      <div style="text-align: center; padding: 40px; color: #666;">
        <h4>üìä No hay diagramas generados</h4>
        <p>Usa el chat para generar nuevos diagramas para este archivo.</p>
      </div>
      {% endif %}
    </div>

    <!-- SECCI√ìN DE CHAT -->
    <div class="chat-section">
      <h3>üí¨ Chat IA - {{ source.name }}</h3>
      <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
        Genera gr√°ficos espec√≠ficos para este archivo
      </p>
      
      <div id="chat-box"></div>
      
      <div class="chat-input-container">
        <input type="text" id="user-input" placeholder="Ej: Ventas por categor√≠a..." />
        <button id="send-btn">Enviar</button>
      </div>
      
      <!-- PREVIEW DEL NUEVO DIAGRAMA -->
      <div id="preview-section" class="preview-section">
        <h4>üéØ Preview del Nuevo Diagrama</h4>
        <div style="margin: 10px 0;">
          <strong>T√≠tulo:</strong> <span id="preview-title"></span><br>
          <strong>Tipo:</strong> <span id="preview-type"></span><br>
          <strong>Descripci√≥n:</strong> <span id="preview-description"></span>
        </div>
        
        <div class="chart-container" style="height: 200px;">
          <canvas id="preview-chart"></canvas>
        </div>
        
        <div style="text-align: center; margin-top: 15px;">
          <button class="save-diagram-btn" id="save-diagram-btn">üíæ Guardar este Diagrama</button>
          <button class="btn-small btn-delete" onclick="cerrarPreview()">‚ùå Descartar</button>
        </div>
      </div>
      <!-- PREVIEW DE PREDICCI√ìN (ML) -->
      <div id="ml-preview" class="preview-section" style="display:none;">
        <h4>ü§ñ Predicci√≥n (Preview)</h4>

        <div style="margin: 10px 0;">
          <strong>Modelo:</strong> <span id="ml-model-id"></span><br>
          <strong>Target:</strong> <span id="ml-target"></span><br>
          <strong>Filas procesadas:</strong> <span id="ml-n-rows"></span><br>
          <strong>Columna escrita:</strong> <span id="ml-writeback"></span>
        </div>

        <div>
          <strong>M√©tricas:</strong>
          <pre id="ml-metrics" style="background:#fff;padding:10px;border-radius:6px;border:1px solid #ddd;max-height:220px;overflow:auto;"></pre>
        </div>

        <div style="margin-top:10px;">
          <strong>Gr√°ficos:</strong>
          <div id="ml-charts" style="display:grid;grid-template-columns:1fr;gap:12px;max-height:520px;overflow:auto;"></div>
        </div>

        <div style="text-align:center;margin-top:10px;">
          <button class="btn-small btn-delete" onclick="cerrarMLPreview()">‚ùå Cerrar</button>
        </div>
      </div>

    </div>
  </div>

  <div id="email-modal-simple" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:10px; width:350px;">
      <h3>üìß Enviar Gr√°fico por Email</h3>
      <div style="margin:15px 0;">
        <label>Email destinatario:</label>
        <input type="email" id="email-destinatario-simple" placeholder="ejemplo@correo.com" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:5px;">
      </div>
      <div style="text-align:center; margin-top:25px;">
        <button onclick="confirmarEnvioEmail()" style="background:#4CAF50; color:white; padding:12px 25px; border:none; border-radius:5px; margin:0 10px; font-weight:bold;">üì§ Enviar PDF</button>
        <button onclick="cerrarModalSimple()" style="background:#f44336; color:white; padding:12px 25px; border:none; border-radius:5px; margin:0 10px; font-weight:bold;">‚ùå Cancelar</button>
      </div>
    </div>
  </div>


<script>
  const chatBox = document.getElementById("chat-box");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const previewSection = document.getElementById("preview-section");
  const saveDiagramBtn = document.getElementById("save-diagram-btn");
  const mlPreview   = document.getElementById('ml-preview');
  const mlModelId   = document.getElementById('ml-model-id');
  const mlTarget    = document.getElementById('ml-target');
  const mlNRows     = document.getElementById('ml-n-rows');
  const mlWriteBack = document.getElementById('ml-writeback');
  const mlMetricsEl = document.getElementById('ml-metrics');
  const mlChartsBox = document.getElementById('ml-charts');
let mlChartInstances = [];
  
  let previewChart = null;
  let currentPreviewData = null;

  function addMessage(type, text) {
    const p = document.createElement("p");
    p.className = type === "user" ? "msg-user" : (type === "bot" ? "msg-bot" : "msg-err");
    p.textContent = (type === "user" ? "T√∫: " : type === "bot" ? "IA: " : "Error: ") + text;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function mostrarPreview(diagramaData) {
    // Mostrar informaci√≥n del diagrama
    document.getElementById('preview-title').textContent = diagramaData.title;
    document.getElementById('preview-type').textContent = diagramaData.chart_type;
    document.getElementById('preview-description').textContent = diagramaData.description;
    
    // Renderizar gr√°fico de preview
    if (previewChart) previewChart.destroy();
    
    const ctx = document.getElementById('preview-chart').getContext('2d');
    previewChart = new Chart(ctx, {
      type: diagramaData.chart_type,
      data: diagramaData.chart_data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: diagramaData.title,
            font: { size: 12 }
          }
        }
      }
    });
    
    // Guardar datos para posterior guardado
    currentPreviewData = diagramaData;
    
    // Mostrar secci√≥n de preview
    previewSection.style.display = 'block';
  }

  function cerrarPreview() {
    previewSection.style.display = 'none';
    if (previewChart) {
      previewChart.destroy();
      previewChart = null;
    }
    currentPreviewData = null;
  }

  // Enviar mensaje al chat integrado
  sendBtn.addEventListener("click", () => {
    const text = userInput.value.trim();
    if (!text) return;

    addMessage("user", text);
    userInput.value = "";

    fetch("{% url 'ingestion:chat_integrado' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ 
        source_id: {{ source.id }}, 
        mensaje: text 
      })
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.error) {
        addMessage("err", data.error);
        return;
      }
      if (!data.success) {
        addMessage("err", "La operaci√≥n no fue exitosa.");
        return;
      }

      if (data.ask) {
        addMessage("bot", data.ask);
        return;
      }

      // üëá NUEVO: soporte para predicci√≥n
      if (data.mode === 'ml_predict' && data.ml) {
        const msg =
          `Modelo entrenado (${data.ml.model_id || 'id no disponible'}). ` +
          (data.ml.write_back_col ? `Se escribi√≥ la columna "${data.ml.write_back_col}". ` : '') +
          `Se generaron ${(data.ml.charts || []).length} gr√°fico(s).`;
        addMessage("bot", msg);

        // cierra preview de gr√°fico si estaba abierto
        cerrarPreview && cerrarPreview();
        // muestra preview ML
        showMLPreview(data.ml);
        return;
      }

      // Modo gr√°fico (lo de siempre)
      if (data.diagrama) {
        addMessage("bot", data.diagrama.description);
        cerrarMLPreview(); // cierra preview ML si estaba abierto
        mostrarPreview(data.diagrama);
      } else {
        addMessage("err", "No recib√≠ contenido para mostrar.");
      }
    })
    .catch(err => addMessage("err", String(err)));
  });

  // Guardar diagrama
  saveDiagramBtn.addEventListener("click", () => {
    if (!currentPreviewData) return;
    
    fetch("{% url 'ingestion:guardar_diagrama' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        source_id: {{ source.id }},
        title: currentPreviewData.title,
        description: currentPreviewData.description,
        chart_type: currentPreviewData.chart_type,
        chart_data: currentPreviewData.chart_data,
        sql_query: currentPreviewData.sql_query
      })
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        addMessage("bot", "‚úÖ Diagrama guardado exitosamente");
        cerrarPreview();
        // Recargar p√°gina para mostrar nuevo diagrama
        setTimeout(() => location.reload(), 1000);
      } else {
        addMessage("err", data.error);
      }
    })
    .catch(err => addMessage("err", String(err)));
  });

  // Enter para enviar
  userInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      sendBtn.click();
    }
  });

  // Funciones para acciones de diagramas existentes
  function actualizarDiagrama(diagramaId) {
    fetch(`{% url 'ingestion:actualizar_diagrama' 0 %}`.replace('0', diagramaId), {
      method: 'GET'
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        addMessage("bot", "‚úÖ Diagrama actualizado");
        setTimeout(() => location.reload(), 1000);
      } else {
        addMessage("err", data.error);
      }
    });
  }

  function exportarDiagrama(diagramaId) {
    const canvas = document.getElementById(`chart-${diagramaId}`);
    const link = document.createElement('a');
    link.download = `diagrama_${diagramaId}_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    addMessage("bot", "‚úÖ Diagrama exportado como imagen");
  }
  function exportarPDF(diagramaId) {
    const canvas = document.getElementById(`chart-${diagramaId}`);
    if (!canvas) return alert("‚ùå No se encontr√≥ el gr√°fico");

    html2canvas(canvas, { backgroundColor: "#fff", scale: 2 }).then(canvas => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("landscape");
      pdf.setFontSize(16);
      pdf.text(`Gr√°fico ${diagramaId}`, 20, 20);

      const imgData = canvas.toDataURL("image/png");
      const imgWidth = 250;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, "PNG", 20, 40, imgWidth, imgHeight);

      pdf.save(`diagrama_${diagramaId}.pdf`);
    });
  }let canvasSeleccionado = null;
let tituloSeleccionado = "";

function abrirModalEmail(diagramaId, titulo) {
  canvasSeleccionado = document.getElementById(`chart-${diagramaId}`);
  tituloSeleccionado = titulo || `Gr√°fico ${diagramaId}`;
  
  if (!canvasSeleccionado) {
    alert("No se encontr√≥ el gr√°fico para exportar");
    return;
  }

  document.getElementById('email-modal-simple').style.display = 'block';
  document.getElementById('email-destinatario-simple').focus();
}

function cerrarModalSimple() {
  document.getElementById('email-modal-simple').style.display = 'none';
  document.getElementById('email-destinatario-simple').value = '';
}

function confirmarEnvioEmail() {
  const destinatario = document.getElementById('email-destinatario-simple').value;
  
  if (!destinatario || !destinatario.includes('@')) {
    alert("Por favor ingresa un email v√°lido");
    return;
  }

  if (!canvasSeleccionado) {
    alert("No hay gr√°fico seleccionado");
    return;
  }

  cerrarModalSimple();
  alert("‚è≥ Generando PDF, por favor espera...");

  // Capturar el gr√°fico con html2canvas
  html2canvas(canvasSeleccionado, { 
    backgroundColor: '#ffffff', 
    scale: 2,   // Mejora la calidad
    useCORS: true 
  })
  .then(canvas => {
    try {
      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        alert("‚ùå jsPDF no est√° cargado correctamente");
        return;
      }

      const pdf = new jsPDF('landscape');
      pdf.setFontSize(16);
      pdf.text(tituloSeleccionado, 20, 25);
      pdf.setFontSize(11);
      pdf.text(`Generado: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, 35);

      // Convertir canvas a imagen
      const imgData = canvas.toDataURL('image/jpeg', 0.8);
      const imgWidth = 240;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, 'JPEG', 20, 50, imgWidth, imgHeight);

      pdf.setFontSize(9);
      pdf.text('Software2 BI', 20, pdf.internal.pageSize.height - 15);

      // Convertir a base64 para enviar por backend
      const pdfData = pdf.output('datauristring');
      const fileName = `grafico_${Date.now()}.pdf`;

      // Enviar al backend
      fetch("{% url 'ingestion:enviar_email' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          destinatario: destinatario,
          asunto: `Reporte: ${tituloSeleccionado}`,
          mensaje: `Hola,\n\nAdjunto el gr√°fico "${tituloSeleccionado}".\n\nGenerado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}.\n\nSaludos,\nSoftware2 BI`,
          attachment: pdfData,
          fileName: fileName,
          formato: 'pdf'
        })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          alert(`‚úÖ PDF enviado a ${destinatario}`);
        } else {
          alert(`‚ùå Error: ${data.error}`);
        }
      })
      .catch(err => alert("‚ùå Error de conexi√≥n: " + err.message));

    } catch (e) {
      alert("‚ùå Error generando PDF: " + e.message);
    }
  })
  .catch(err => alert("‚ùå Error al capturar el gr√°fico: " + err.message));
}

function showMLPreview(ml) {
  mlModelId.textContent   = ml.model_id || '(sin id)';
  mlTarget.textContent    = ml.target || '(desconocido)';
  mlNRows.textContent     = (ml.n_rows ?? '‚Äî');
  mlWriteBack.textContent = ml.write_back_col || '‚Äî';

  try { mlMetricsEl.textContent = JSON.stringify(ml.metrics || {}, null, 2); }
  catch { mlMetricsEl.textContent = String(ml.metrics || ''); }

  // limpiar charts previos
  mlChartInstances.forEach(ch => { try { ch.destroy(); } catch{} });
  mlChartInstances = [];
  mlChartsBox.innerHTML = '';

  (ml.charts || []).forEach((c, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'chart-container';
    wrap.style.height = '260px';

    const canvas = document.createElement('canvas');
    canvas.id = `ml-chart-${Date.now()}-${idx}`;
    canvas.className = 'chart-canvas';
    wrap.appendChild(canvas);
    mlChartsBox.appendChild(wrap);

    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
      type: (c.chart_type || 'bar'),
      data: c.data || { labels: [], datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: !!c.title, text: c.title || '', font: { size: 14 } },
          legend: { display: true }
        },
        scales: { x: { ticks: { autoSkip: true, maxRotation: 0 } } }
      }
    });
    mlChartInstances.push(chart);
  });

  mlPreview.style.display = 'block';
}

function cerrarMLPreview() {
  mlPreview.style.display = 'none';
  mlChartInstances.forEach(ch => { try { ch.destroy(); } catch{} });
  mlChartInstances = [];
  mlChartsBox.innerHTML = '';
}


</script>

</body>
</html>
{% endblock %}